---
title: "SDS230_FinalProject"
author: "Tejita Agarwal, Lelan Hu, Franklin She"
date: "5/5/2021"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Packages
library(plyr)
library(car)
library(leaps)
library(PerformanceAnalytics)
source("http://www.reuningscherer.net/s&ds230/Rfuncs/regJDRS.txt")
```

**Introduction**
Background and motivation, not more than a short paragraph

**Data**
*The data used in this analysis are:

1. school - student's school (binary: 'GP' - Gabriel Pereira or 'MS' - Mousinho da Silveira); categorical
2. sex - student's sex (binary: 'F' - female or 'M' - male); categorical
3. age - student's age (numeric: from 15 to 22); continuous (discrete integers, makes sense to be treated as continuous variable, because of the nature of the variable)
4. studytime - weekly study time (numeric: 1 - 10 hours); continuous (discrete integers, makes sense to be treated as continuous variable, because of the nature of the variable)
5. higher - wants to take higher education (binary: yes or no); categorical
6. freetime - free time after school (numeric: from 1 - very low to 5 - very high); continuous (discrete integers, makes sense to be treated as continuous variable, because of the nature of the variable)
7. goout - going out with friends (numeric: from 1 - very low to 5 - very high); continuous (discrete integers, makes sense to be treated as continuous variable, because of the nature of the variable)
8. Dalc - workday alcohol consumption (numeric: from 1 - very low to 5 - very high); continuous (discrete integers, makes sense to be treated as continuous variable, because of the nature of the variable)
9. Walc - weekend alcohol consumption (numeric: from 1 - very low to 5 - very high); continuous (discrete integers, makes sense to be treated as continuous variable, because of the nature of the variable)
10. health - current health status (numeric: from 1 - very bad to 5 - very good); continuous (discrete integers, makes sense to be treated as continuous variable, because of the nature of the variable)
11. absences - number of school absences (numeric: from 0 to 93); continuous (discrete integers, makes sense to be treated as continuous variable, because of the nature of the variable)
12. grade - final grade (numeric: from 0 to 20); continuous (discrete integers, makes sense to be treated as continuous variable, because of the nature of the variable)*

**Data Cleaning Process**
Describe the cleaning process you used on your data. Talk about what issues you encountered.
Demonstrate use of find/replace, data cleaning, dealing with missing values, text character replacement, matching. It’s ok if your data didn’t require much of this.

```{r}
all_data <- read.csv("student-por.csv", header=TRUE)
selected_data <- all_data[, c("school", "sex", "age", "studytime", "higher", "freetime", "goout", "Dalc", "Walc", "health", "absences", "G3")]

# rename G3 to grade
selected_data <- rename(selected_data, c("G3"="grade"))

# remove observations where grade is 0
selected_data <- selected_data[selected_data$grade != 0,]

nrow(selected_data)
names(selected_data)
head(selected_data)
str(selected_data)

attach(selected_data)
```


**Descriptive Plots**
Plots should be clearly labeled, well formatted, and display an aesthetic sense.
Show appropriate use of at least ONE of each of the following – boxplot, scatterplot (can be matrix plot), normal quantile plot (can be related to regression), residual plots, histogram.
```{r}
# boxplots of grade by school and by sex
boxplot(grade ~ school, main = "Boxplot of Grades by School", ylab = "Grade / Scale(0 - 20)", col = "blue", xlab = "School")
boxplot(grade ~ sex, main = "Boxplot of Grades by Sex", ylab = "Grade / Scale(0 - 20)", col = "green", xlab = "Sex")


# scatterplots of age and alcohol consumption (weekend and weekday)
plot(jitter(age, factor = 1), jitter(Walc), pch = 19, col = "red", xlab = "Age",
     ylab = "Weekend Alcohol Consumption", cex = 0.5)
mtext("Weekend Alcohol Consumption vs. Age", cex = 1.2, line = 1)
mtext(paste("Sample Correlation =", round(cor(age, Walc), 3)), cex = 1.2, line = 0)

plot(jitter(age, factor = 1), jitter(Dalc), pch = 19, col = "blue", xlab = "Age",
     ylab = "Weekday Alcohol Consumption", cex = 0.5)
mtext("Weekday Alcohol Consumption vs. Age", cex = 1.2, line = 1)
mtext(paste("Sample Correlation =", round(cor(age, Dalc), 3)), cex = 1.2, line = 0)

# histogram of grade
hist(grade, main = "Histogram of Grades", xlab = "Grade (0 - 20)", xlim = c(0, 20), col = "orange")
hist(freetime, main = "Histogram of Freetime", xlab = "Freetime)", col = "orange", breaks = 6)
hist(goout, main = "Histogram of Going Out", xlab = "Time Going Out With Friends)", col = "orange")

chart.Correlation(selected_data[, c(3,4,6:12)], histogram = TRUE, pch = 19)
##might be useful to transform Walc, Dalc, and absences. for now, I will try a sqrt transformation of abs, and log transformation of Walc and Dalc. 


transdata <- selected_data[, c(3,4,6:12)]
transdata$logWalc <- log(transdata$Walc + 1)
transdata$logDalc <- log(transdata$Dalc + 1)
transdata$sqrtabs <- sqrt(transdata$absences)
chart.Correlation(transdata[, c(1:4,7,9:12)], histogram = TRUE, pch = 19)

```

**Summary Information**
*(idk for sure what goes here) Our preliminary descriptive plots show that grades, freetime, and time going out are appear to be approximately normally distributed. The box plots indicate there may be significant difference in the mean of grades between the two schools and between females and males. Our initial matrix plot indicates that transformations of the variables absences, Dalc, and Walc may be helpful. These three variables all appear strongly right skewed. This was expected for Walc and Dalc, which measure alcohol consumption, because many students reported that they do not consume any alcohol. As expected, there is a strong correlation between Walc and Dalc on both the raw and log scale and this indicates that collinearity may need to be considered in our models. (idk if this is like...correct. pls help) Interestingly, there does not appear to be a singificant correlation between age and grades. (pls add more) *

**Analysis**
Basic tests - t-test, correlation, AND ability to create bootstrap confidence interval for either a t-test or a correlation.
Permutation Test – include at least one.
Multiple Regression – use either backwards stepwise regression or some form of best subsets regression. Should include residual plots. A GLM with a mix of continuous and categorical predictors is fine here.
AT LEAST ONE OF THE FOLLOWING TECHNIQUES – ANOVA, ANCOVA, Logistic Regression, Multinomial Regression, OR data scraping off a website.
```{r}

t.test(Walc ~ sex) ## sig
t.test(log10(Walc) ~ sex) ## still significant
t.test(Dalc ~ sex) ## sig
t.test(log10(Dalc) ~ sex) ## still significant
t.test(studytime ~ sex) ## sig
t.test(grade ~ sex) ## sig
t.test(grade ~ school) ## sig
t.test(Walc ~ school) ## not significant
t.test(log10(Walc) ~ school) ## still not significant
t.test(Dalc ~ school) ## not sig
t.test(log10(Dalc) ~ school) ## still not significant
```
*Discussion of t-test results:*
**The results of a two-sample t-test showed that there was enough evidence to reject the null hypothesis that the difference in means of weekend and weekday alcohol consumption for Females and Males was equal to zero. This was also true on the log scale. Additionally, a t-test showed significant difference in study time and grades for females and males, and showed significant differences in grades between schools. There was not enough evidence to reject the null hypothesis that the difference in mean weekday alcohol consumption between schools was equal to zero. This was true on the log scale and for weekend alcohol consumption as well.**

```{r}
##correlations are already provided in the matrix plot above, should we do this again? 
#### perhaps we should do some, so we can provide some discussion of the results and talk about the statistical significance 


```


```{r}
#Bootstrap 1 of grades and Weekday Alcohol Consumption

#Recoding Dalc to a binary, for later use 
#For some reason, every time you re-run this code, Dalc doesn't update back to numbers, so adding the rm(Dalc2) reverts it 
rm(Dalc2)
Dalc2 <- rep(NA, length(Dalc))

for (i in 1:634) {
  if (Dalc[i] == 1) {
    Dalc2[i] <- "None"
  } else {
    Dalc2[i] <- "Some"
  }
}

#t test for the binary version of Dalc 
t.test(grade ~ Dalc2)

#Make normal quantile plot of grades
library(car)
qqPlot(grade, col = 2, pch = 18, main = "Normal Quantile Plot of Grades")

#Boxplot of grades by Dalc2
boxplot(grade ~ Dalc2, main = "Boxplot of Grades by Weekday Alcohol Consumption", cex.main = 0.7, col = c(2:4), lwd = 2)

#Count number of non-missing values in each level of weekday alcohol consumption
sum(Dalc2 == "None")
sum(Dalc2 == "Some")

#Set number of bootstrap samples to take
N <- 10000

#Make empty vector for sample mean differences
diffGrade <- rep(NA, N)

for (i in 1:N) {
  sN <- sample(grade[Dalc2 =="None"], sum(Dalc2 == "None"), replace = TRUE)
  sS <- sample(grade[Dalc2 =="Some"], sum(Dalc2 == "Some"), replace = TRUE)
  diffGrade[i] <- mean(sN) - mean(sS)
}

#Get bootstrap quantiles
ci <- quantile(diffGrade, c(0.025, 0.975))

#Report these values
round(ci,1)
#compare to original 95% CI for the mean
Gradet_test <- t.test(grade ~ Dalc2)$conf.int
round(Gradet_test,2)

#Make histogram of bootstrap sample means
hist(diffGrade, col = "blue", main = "Bootstrapped Sample Means Diff in Grades against Weekday Alcohol Consumption", cex.main = 0.7, xlab = "Grades", breaks = 50)

#Add lines to histogram for CI's
abline(v = ci, lwd = 3, col = "red")
abline(v = Gradet_test, lwd = 3, col = "green", lty = 2)
legend("topright", c("Original CI","Boot CI"), lwd = 3, col = c("green","red"), lty = c(2,1))

#Normal quantile plot of the bootstrapped differences in means
qqPlot(diffGrade, pch = 19, col = 'red', main = "NQ Plot of Bootstrapped Differences in Means \n of Grades based on Weekday Alcohol Consumption")

```


```{r}
#Bootstrap 2 of grades and Walc (Weekend Alcohol Consumption)
rm(Walc2)
Walc2 <- rep(NA, length(Walc))

for (i in 1:634) {
  if (Walc[i] == 1) {
    Walc2[i] <- "None"
  } else {
    Walc2[i] <- "Some"
  }
}

t.test(grade ~ Walc2)

boxplot(grade ~ Walc2, main = "Boxplot of Grades by Weekend Alcohol Consumption", cex.main = 0.7, col = c(2:4), lwd = 2)

N <- 10000
diffGradeW <- rep(NA, N)

for (i in 1:N) {
  sNW <- sample(grade[Walc2 =="None"], sum(Walc2 == "None"), replace = TRUE)
  sSW <- sample(grade[Walc2 =="Some"], sum(Walc2 == "Some"), replace = TRUE)
  diffGradeW[i] <- mean(sNW) - mean(sSW)
}

ciW <- quantile(diffGradeW, c(0.025, 0.975))
round(ciW,1)

Gradet_testW <- t.test(grade ~ Walc2)$conf.int
round(Gradet_testW,2)

hist(diffGradeW, col = "blue", main = "Bootstrapped Sample Means Diff in Grades against Weekend Alcohol Consumption", cex.main = 0.7, xlab = "Grades", breaks = 50)
abline(v = ciW, lwd = 3, col = "red")
abline(v = Gradet_testW, lwd = 3, col = "green", lty = 2)
legend("topright", c("Original CI","Boot CI"), lwd = 3, col = c("green","red"), lty = c(2,1))

qqPlot(diffGradeW, pch = 19, col = 'red', main = "NQ Plot of Bootstrapped Differences in Means \n of Grades based on Weekend Alcohol Consumption")
```

```{r}
#Bootstrap 3 of Dalc and age using non-binary data (FOR TEJ AND FRANKIE: IF WE DO NOT PERCEIVE DALC AS CONTINUOUS PLEZ DELETE THIS)

#We have jitter plot for Dalc vs age above

#Calculate the correlation
(cor1 <- cor(age, Dalc))

#Test if correlation is non-zero
cor.test(age, Dalc)

#Fit simple linear regression
lm1 <- lm(Dalc ~ age)
summary(lm1) 

#Do bootstrap
n_samp <- 10000

corResults <- rep(NA, n_samp)
bResults <- rep(NA, n_samp) 

for(i in 1:n_samp){
  s <- sample(1:634, 634, replace = T)
  fakeData <- cbind(age[s], Dalc[s])
  
  #Get bootstrapped correlation and regression slope
  corResults[i] <- cor(fakeData[, 1], fakeData[, 2])
  bResults[i] <- lm(fakeData[, 2] ~ fakeData[, 1])$coef[2]
}

#Get percentiles for 2.5 and 97.5
ci_r <- quantile(corResults, c(.025, .975))
ci_slope <- quantile(bResults, c(.025, .975))

#Histogram of bootstrapped correlation values with CI's (both bootstrapped and theoretical)
hist(corResults, col = "blue", main = "Bootstrapped Correlations", xlab = "Sample Correlation", breaks = 50)
abline(v = ci_r, lwd = 3, col = "red")
abline(v = cor.test(age, Dalc)$conf.int, lwd = 3, col = "green", lty = 2)
legend(-0.3, 450, c("Theoretical CI","Boot CI"), lwd = 3, col = c("green","red"), lty = c(2, 1))

library(car)
qqPlot(corResults, main = "NQ Plot of Bootstrapped Correlations")

#Histogram of bootstrapped regression slopes with CI's (both bootstrapped and theoretical)
hist(bResults, col = "blue", main = "Bootstrapped Slopes", xlab = "Sample Slope", breaks = 50)
abline(v = ci_slope, lwd = 3, col = "red")
abline(v = confint(lm1,'age'), lwd = 3, col = "green", lty = 2)
legend("topleft", c("Theoretical CI","Boot CI"), lwd = 3, col = c("green","red"), lty = c(2, 1))

qqPlot(bResults, main = "NQ Plot of Bootstrapped Regression Slopes")

#reminder of regression results
summary(lm1)
```
*Bootstrap Discussion*
**(lelan can you do this), comparison to t-test, also may need to adjust title of last bootstrap graphs**

```{r}
##Permutation test (grade by school)
(actualdiff <- by(grade, school, mean))
(actualdiff <- actualdiff[1] - actualdiff[2])
set.seed(1)
N <- 10000
diffvals <- rep(NA, N)
for (i in 1:N) {
  fakeschool <- sample(school)  # default is replace = FALSE
  diffvals[i] <- mean(grade[fakeschool == "GP"]) -  mean(grade[fakeschool == "MS"])
}

hist(diffvals, col = "yellow", main = "Permuted Sample Means Diff in Grades between Schools", xlab = "Grade Diff", breaks = 50, xlim = c(-1.2, 1.5))
abline(v = actualdiff, col = "blue", lwd = 3)
text(actualdiff - 0.1, 300 , paste("Actual Diff in Means =", round(actualdiff,2)),srt = 90)

mean(abs(diffvals) >= abs(actualdiff)) ## p-value is approximately 0
```
*Permutation Test Discussion*
**The result of the permutation test was that there is enough evidence to reject the null hypothesis that the difference in means of grades between the schools is zero. The permuted p-value was approximately 0, which is similar to the theoretical p-value calculated earlier to be 6.261e-08. These p-values are below alpha 0.05 and therefore we reject the null.**

```{r}
# Multiple Regression to predict grade (Best Subsets Regression, Bayesian Information Criteria)
mod1 <- regsubsets(grade ~ ., data = selected_data, nvmax = 11)
mod1sum <- summary(mod1)
names(selected_data)[mod1sum$which[which.min(mod1sum$bic), ]][-1] # names of the predictors
gradeBIC <- selected_data[,mod1sum$which[which.min(mod1sum$bic), ]]
modfin <- lm(grade ~ ., data = gradeBIC)
summary(modfin) # summary of best model according to BIC
# TODO: pls check my work ^^^ ... it seems one of the chosen predictors (freetime) has a p-value greater than 0.05? 
### maybe R is using alpha = 0.10 and thats why it was included
myResPlots2(modfin) # normal quantile and residual plot for model





## anova



```


**Conclusions**
a short paragraph
##remember to take our names off!!

